generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER // Cliente normal
  ADMIN // Admin
  OPERATOR_BO // Empleado en Bolivia (Valida depósitos)
  OPERATOR_PE // Empleado en Perú (Valida tesorería)
}

enum KycStatus {
  UNVERIFIED // Recién registrado
  PENDING // Subió documentos, espera revisión
  VERIFIED // Aprobado (Puede comprar/vender)
  REJECTED // Documentos inválidos
  BLACKLISTED // Bloqueado por seguridad/OFAC
}

enum Country {
  BOLIVIA
  PERU
}

enum FiatCurrency {
  BOB 
  PEN 
}

enum DepositStatus {
  PENDING
  APPROVED
  REJECTED
  MINTED
}

enum TransactionType {
  MINT
  BURN
  TRANSFER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum Network {
  BNB_CHAIN_MAINNET
  BNB_CHAIN_TESTNET
}

model User {
  id          String  @id @default(uuid())
  email       String  @unique
  password    String
  //Datos Personales usuario
  firstName   String
  lastName    String
  phoneNumber String?
  country     Country @default(BOLIVIA)

  //Datos Blockchain & financieros

  walletAddress String?   @unique
  kycStatus     KycStatus @default(UNVERIFIED)

  //Auditoria
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  //Roles y permisos
  role                UserRole  @default(USER)
  resetPasswordToken  String?
  resetPasswordExpiry DateTime?

  //Relaciones
  kycDocuments KycDocument[]
  transactions Transaction[]
  deposits     Deposit[]  

  @@map("users")
}

model KycDocument {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  docType    String // e.g., "passport", "ID card"
  docUrl     String // URL to the stored document
  uploadedAt DateTime @default(now())

  @@map("kyc_documents")
}

model Transaction {
  id          String            @id @default(uuid())
  user        User              @relation(fields: [userId], references: [id])
  userId      String
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  // red y hash on-chain
  network     Network
  txHash     String?           @unique
  blockNumber Int?
  confirmedAt DateTime?
  amount      Decimal           @db.Decimal(36, 18)
  deposit     Deposit?          @relation(fields: [depositId], references: [id])
  depositId   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime?         @updatedAt

  @@map("transactions")
  @@index([userId, createdAt])
  @@index([txHash])
}

model Deposit {
  id            String        @id @default(uuid())
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  currency      FiatCurrency
  amount        Float         //monto depositado (sin fee)
  feeRate       Float         //comision fija 0.001 (0.1%)
  serviceFee    Float         //amount * feeRate
  totalAmount   Float         //amount + serviceFee
  rateUsed      Float         // BOB: 1, PEN: PEN->BOB del momento
  expectedBOBH  Float         // BOB: amount, PEN: amount * rateUsed
  referenceCode String        @unique
  status        DepositStatus @default(PENDING)
  validatedById String?
  validatedAt   DateTime?
  mintTxHash    String?
  mintedAt      DateTime?
  createdAt     DateTime      @default(now())
  processedAt   DateTime?     @updatedAt

  //Relaciones
  transactions Transaction[]

  @@map("deposits")
}